version: '3.8'

services:
  postgres-america:
    image: postgres:17  
    container_name: postgres-america  
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: globalshop
      POSTGRES_USER: symmetricds
      POSTGRES_PASSWORD: symmetricds
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db/postgres/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    networks:
      - globalshop-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U symmetricds -d globalshop"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-europe:
    image: mysql:8.0
    container_name: mysql-europe  
    ports:
      - "3306:3306"
    environment:
      MYSQL_DATABASE: globalshop
      MYSQL_USER: symmetricds
      MYSQL_PASSWORD: symmetricds
      MYSQL_ROOT_PASSWORD: rootpassword
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init-db/mysql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d 
    networks:
      - globalshop-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-hlocalhost", "-u", "symmetricds", "-psymmetricds"]
      interval: 10s
      timeout: 5s
      retries: 5

  symmetricds-america:
    image: jumpmind/symmetricds:3.16 
    container_name: symmetricds-america
    environment:
      - SYMMETRIC_HOME=/opt/symmetric-ds
    ports:
      - "31415:31415"
    volumes:
      - ./symmetricds/america:/opt/symmetric-ds/engines
    depends_on:
      postgres-america:
        condition: service_healthy
    networks:
      - globalshop-network

  symmetricds-europe:
    image: jumpmind/symmetricds:3.16
    container_name: symmetricds-europe
    environment:
      - SYMMETRIC_HOME=/opt/symmetric-ds
      - SYMMETRICDS_ENGINE_NAME=europe
      - SYMMETRICDS_DB_DRIVER=com.mysql.cj.jdbc.Driver
      - SYMMETRICDS_DB_URL=jdbc:mysql://mysql-europe:3306/globalshop?allowPublicKeyRetrieval=true&useSSL=false
      - SYMMETRICDS_DB_USER=symmetricds
      - SYMMETRICDS_DB_PASSWORD=symmetricds
      - SYMMETRICDS_REGISTRATION_URL=http://symmetricds-america:31415/sync
      - SYMMETRICDS_HTTP_PORT=31416
      - SYMMETRICDS_AUTO_REGISTER=true
    ports:
      - "31416:31416"
    volumes:
      - ./symmetricds/europe:/opt/symmetric-ds/engines 
    depends_on:
      mysql-europe:
        condition: service_healthy
      symmetricds-america:
        condition: service_started
    networks:
      - globalshop-network


networks:
  globalshop-network:
    driver: bridge

volumes:
  postgres-data:
  mysql-data:
